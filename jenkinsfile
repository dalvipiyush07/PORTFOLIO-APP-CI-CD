pipeline {
    agent any

    environment {
        DEPLOY_USER = 'ubuntu'                // <-- your remote server username
        DEPLOY_HOST = '3.110.209.161'          // <-- your EC2 public or private IP
        DEPLOY_PATH = '/var/www/html'         // <-- web root
        SSH_CREDENTIALS_ID = 'node-app-key'     // <-- Jenkins credentials ID
        REPO_URL = 'https://github.com/dalvipiyush07/PORTFOLIO-APP-CI-CD.git'
        BRANCH = 'main'
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'ðŸ“¦ Checking out portfolio code from GitHub...'
                git branch: "${BRANCH}", url: "${REPO_URL}"
            }
        }

        stage('Prepare Deployment Server') {
            steps {
                echo 'âš™ï¸ Setting up Nginx and cleaning old files on remote server...'
                sshagent (credentials: ["${SSH_CREDENTIALS_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} '
                            sudo apt update -y &&
                            sudo apt install nginx -y &&
                            sudo systemctl enable nginx &&
                            sudo systemctl start nginx &&
                            sudo mkdir -p ${DEPLOY_PATH} &&
                            sudo chown -R ${DEPLOY_USER}:${DEPLOY_USER} ${DEPLOY_PATH} &&
                            sudo chmod -R 755 ${DEPLOY_PATH} &&
                            sudo rm -rf ${DEPLOY_PATH}/*
                        '
                    """
                }
            }
        }

        stage('Deploy Portfolio') {
            steps {
                echo 'ðŸš€ Deploying new portfolio build to server...'
                sshagent (credentials: ["${SSH_CREDENTIALS_ID}"]) {
                    sh """
                        scp -o StrictHostKeyChecking=no -r img index.html ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} '
                            sudo mv /tmp/index.html ${DEPLOY_PATH}/ &&
                            sudo mv /tmp/img ${DEPLOY_PATH}/ &&
                            sudo systemctl restart nginx
                        '
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Deployment successful! Visit your EC2 IP in browser to see your portfolio.'
        }
        failure {
            echo 'âŒ Deployment failed. Please check Jenkins logs.'
        }
    }
}
